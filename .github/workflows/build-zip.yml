name: Build plugin zip

on:
  workflow_run:
    workflows:
      - Build deploy branch
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-zip:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install NPM dependencies
        run: npm ci

      - name: Build assets
        run: npm run build

      # Récupère la version depuis package.json et la met dans GITHUB_OUTPUT
      - name: Get plugin version
        id: meta
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "zip_name=lean-stats-$VERSION.zip" >> "$GITHUB_OUTPUT"
          echo "tag=v$VERSION" >> "$GITHUB_OUTPUT"

      # Prépare un dossier "lean-stats/" propre (déployable) et génère le zip versionné dans dist/
      - name: Create deployable plugin zip (clean)
        run: |
          set -euo pipefail

          PLUGIN_SLUG="lean-stats"
          ZIP_NAME="${{ steps.meta.outputs.zip_name }}"

          rm -rf dist package-tmp
          mkdir -p "dist" "package-tmp/${PLUGIN_SLUG}"

          rsync -a --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "node_modules" \
            --exclude "dist" \
            --exclude "src" \
            --exclude "tests" \
            --exclude "docs" \
            --exclude "scripts" \
            --exclude "assets/js/__tests__" \
            --exclude ".eslintrc.json" \
            --exclude "phpcs.xml" \
            --exclude "phpunit.xml.dist" \
            --exclude "webpack.config.js" \
            --exclude "AGENTS.md" \
            --exclude "package.json" \
            --exclude "package-lock.json" \
            ./ "package-tmp/${PLUGIN_SLUG}/"

          # Vérification minimale: le bundle admin doit exister
          test -f "package-tmp/${PLUGIN_SLUG}/build/admin.js"
          test -f "package-tmp/${PLUGIN_SLUG}/build/admin.asset.php"

          (cd package-tmp && zip -r "../dist/${ZIP_NAME}" "${PLUGIN_SLUG}")
          echo "Created dist/${ZIP_NAME}"

      # Artifact (debug) : GitHub l'encapsulera toujours dans un zip "artifact"
      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: lean-stats-${{ steps.meta.outputs.version }}
          path: dist/${{ steps.meta.outputs.zip_name }}
          if-no-files-found: error

      # Release asset (download direct du zip plugin)
      - name: Create/Update GitHub Release and upload asset
        env:
          GH_TOKEN: ${{ github.token }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          set -euo pipefail

          TAG="${{ steps.meta.outputs.tag }}"
          VERSION="${{ steps.meta.outputs.version }}"
          ZIP="dist/${{ steps.meta.outputs.zip_name }}"

          # Notes de release : on préfère le contenu de la PR, sinon fallback sur le titre, sinon générique
          if [ -z "${PR_TITLE:-}" ] || [ -z "${PR_BODY:-}" ]; then
            PR_DATA=$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "repos/${GITHUB_REPOSITORY}/commits/${GITHUB_SHA}/pulls" \
              | jq -r '.[0] // empty')
            if [ -n "$PR_DATA" ]; then
              PR_TITLE=$(echo "$PR_DATA" | jq -r '.title // empty')
              PR_NUMBER=$(echo "$PR_DATA" | jq -r '.number // empty')
              PR_BODY=$(echo "$PR_DATA" | jq -r '.body // empty')
            fi
          fi

          if [ -n "${PR_BODY:-}" ]; then
            NOTES="${PR_BODY}"
          elif [ -n "${PR_TITLE:-}" ]; then
            NOTES="PR #${PR_NUMBER:-?} — ${PR_TITLE}"
          else
            NOTES="Build automatique Lean Stats ${VERSION}"
          fi

          # Crée la release si elle n’existe pas (gh crée aussi le tag si besoin)
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists, will update asset."
            gh release edit "$TAG" --notes "$NOTES"
          else
            gh release create "$TAG" \
              --title "Lean Stats $VERSION" \
              --notes "$NOTES"
          fi

          # Upload/replace l'asset
          gh release upload "$TAG" "$ZIP" --clobber
          echo "Release asset uploaded: $ZIP"
