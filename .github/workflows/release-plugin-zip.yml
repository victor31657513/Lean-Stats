name: Release plugin zip

on:
  workflow_run:
    workflows:
      - Build deploy branch
    types:
      - completed
  workflow_dispatch:
    inputs:
      run_id:
        description: "Run ID de 'Build deploy branch' (dans l'URL du run Actions)"
        required: true
        type: string

permissions:
  actions: read
  contents: write

jobs:
  release-zip:
    if: >-
      ${{
        (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
        github.event_name == 'workflow_dispatch'
      }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Resolve build run id
        id: run
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "run_id=${{ github.event.workflow_run.id }}" >> "$GITHUB_OUTPUT"
          else
            echo "run_id=${{ inputs.run_id }}" >> "$GITHUB_OUTPUT"
          fi

      # Récupère la version depuis package.json et la met dans GITHUB_OUTPUT
      - name: Get plugin version
        id: meta
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v$VERSION" >> "$GITHUB_OUTPUT"

      - name: Download plugin zip artifact
        uses: actions/download-artifact@v4
        with:
          name: plugin-zip
          run-id: ${{ steps.run.outputs.run_id }}
          github-token: ${{ github.token }}
          path: dist

      # Release asset (download direct du zip plugin)
      - name: Create/Update GitHub Release and upload asset
        env:
          GH_TOKEN: ${{ github.token }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          set -euo pipefail

          TAG="${{ steps.meta.outputs.tag }}"
          VERSION="${{ steps.meta.outputs.version }}"
          ZIP="dist/lean-stats.zip"

          # Notes de release : on préfère le contenu de la PR, sinon fallback sur le titre, sinon générique
          if [ -z "${PR_TITLE:-}" ] || [ -z "${PR_BODY:-}" ]; then
            PR_DATA=$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "repos/${GITHUB_REPOSITORY}/commits/${GITHUB_SHA}/pulls" \
              | jq -r '.[0] // empty')
            if [ -n "$PR_DATA" ]; then
              PR_TITLE=$(echo "$PR_DATA" | jq -r '.title // empty')
              PR_NUMBER=$(echo "$PR_DATA" | jq -r '.number // empty')
              PR_BODY=$(echo "$PR_DATA" | jq -r '.body // empty')
            fi
          fi

          if [ -n "${PR_BODY:-}" ]; then
            NOTES="${PR_BODY}"
          elif [ -n "${PR_TITLE:-}" ]; then
            NOTES="PR #${PR_NUMBER:-?} — ${PR_TITLE}"
          else
            NOTES="Build automatique Lean Stats ${VERSION}"
          fi

          # Crée la release si elle n’existe pas (gh crée aussi le tag si besoin)
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists, will update asset."
            gh release edit "$TAG" --notes "$NOTES"
          else
            gh release create "$TAG" \
              --title "Lean Stats $VERSION" \
              --notes "$NOTES"
          fi

          # Upload/replace l'asset
          gh release upload "$TAG" "$ZIP" --clobber
          echo "Release asset uploaded: $ZIP"
